# 🏗️ System Architecture

> Complete system design with data flow diagrams.

---

## 📐 High-Level Architecture

```
┌────────────────────────────────────────────────────────────────────────┐
│                              CLIENTS                                    │
│         ┌──────────┐    ┌──────────┐    ┌──────────┐                   │
│         │ Sensor 1 │    │ Sensor 2 │    │   App    │                   │
│         └────┬─────┘    └────┬─────┘    └────┬─────┘                   │
│              │               │               │                          │
└──────────────┼───────────────┼───────────────┼──────────────────────────┘
               │               │               │
               ▼               ▼               ▼
┌────────────────────────────────────────────────────────────────────────┐
│                         INGEST LAYER                                    │
│  ┌─────────────────────────────┐    ┌─────────────────────────────┐    │
│  │        TCP Server           │    │        UDP Server           │    │
│  │   ┌─────────────────────┐   │    │   ┌─────────────────────┐   │    │
│  │   │ • Port 9000         │   │    │   │ • Port 9001         │   │    │
│  │   │ • Multi-threaded    │   │    │   │ • recvmmsg batch    │   │    │
│  │   │ • Connection pool   │   │    │   │ • Zero-copy         │   │    │
│  │   └─────────────────────┘   │    │   └─────────────────────┘   │    │
│  └──────────────┬──────────────┘    └──────────────┬──────────────┘    │
│                 │                                   │                   │
│                 └───────────────┬───────────────────┘                   │
│                                 ▼                                       │
│                    ┌─────────────────────────┐                         │
│                    │      Frame Codec        │                         │
│                    │  • Length-prefix parse  │                         │
│                    │  • Priority extract     │                         │
│                    │  • Topic routing        │                         │
│                    └────────────┬────────────┘                         │
└─────────────────────────────────┼───────────────────────────────────────┘
                                  │
                                  ▼
┌────────────────────────────────────────────────────────────────────────┐
│                          CORE ENGINE                                    │
│                                                                         │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                        Event Pool (NUMA)                          │  │
│  │   Thread-Local │ Pre-allocated │ Zero malloc │ Custom deleter    │  │
│  └───────────────────────────────┬──────────────────────────────────┘  │
│                                  │                                      │
│  ┌───────────────────────────────▼──────────────────────────────────┐  │
│  │                      Deduplicator (Lock-Free)                     │  │
│  │         CAS-based hash map │ O(1) lookup │ Idempotency           │  │
│  └───────────────────────────────┬──────────────────────────────────┘  │
│                                  │                                      │
│  ┌───────────────────────────────▼──────────────────────────────────┐  │
│  │                      MPSC Queue (Vyukov)                          │  │
│  │        64K capacity │ ~20ns push │ Lock-free │ Multi-producer    │  │
│  └───────────────────────────────┬──────────────────────────────────┘  │
│                                  │                                      │
│  ┌───────────────────────────────▼──────────────────────────────────┐  │
│  │                        Event Bus Multi                            │  │
│  │  ┌─────────────────┬─────────────────┬─────────────────┐         │  │
│  │  │    REALTIME     │  TRANSACTIONAL  │      BATCH      │         │  │
│  │  │   SPSC Queue    │   MPSC Queue    │   MPSC Queue    │         │  │
│  │  │  CRITICAL/HIGH  │     MEDIUM      │    LOW/BATCH    │         │  │
│  │  │    < 100µs      │     < 1ms       │     < 10ms      │         │  │
│  │  └────────┬────────┴────────┬────────┴────────┬────────┘         │  │
│  └───────────┼─────────────────┼─────────────────┼──────────────────┘  │
└──────────────┼─────────────────┼─────────────────┼──────────────────────┘
               │                 │                 │
               ▼                 ▼                 ▼
┌────────────────────────────────────────────────────────────────────────┐
│                          WORKER LAYER                                   │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐         │
│  │    Worker 0     │  │    Worker 1     │  │    Worker N     │         │
│  │  ┌───────────┐  │  │  ┌───────────┐  │  │  ┌───────────┐  │         │
│  │  │CPU-pinned │  │  │  │CPU-pinned │  │  │  │CPU-pinned │  │         │
│  │  │NUMA-local │  │  │  │NUMA-local │  │  │  │NUMA-local │  │         │
│  │  │Batch proc │  │  │  │Batch proc │  │  │  │Batch proc │  │         │
│  │  └───────────┘  │  │  └───────────┘  │  │  └───────────┘  │         │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘         │
└───────────┼────────────────────┼────────────────────┼───────────────────┘
            │                    │                    │
            ▼                    ▼                    ▼
┌────────────────────────────────────────────────────────────────────────┐
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                 │
│  │   Storage   │    │   Metrics   │    │     DLQ     │                 │
│  │  Persister  │    │  Exporter   │    │  Handler    │                 │
│  └─────────────┘    └─────────────┘    └─────────────┘                 │
└────────────────────────────────────────────────────────────────────────┘
```

---

## 🔄 Event Flow Sequence

### Complete Event Lifecycle

```
┌────────┐     ┌────────┐     ┌────────┐     ┌────────┐     ┌────────┐     ┌────────┐
│ Client │     │ Ingest │     │ Codec  │     │ Engine │     │  Bus   │     │ Worker │
└───┬────┘     └───┬────┘     └───┬────┘     └───┬────┘     └───┬────┘     └───┬────┘
    │              │              │              │              │              │
    │  TCP/UDP     │              │              │              │              │
    │─────────────►│              │              │              │              │
    │              │              │              │              │              │
    │              │  Raw bytes   │              │              │              │
    │              │─────────────►│              │              │              │
    │              │              │              │              │              │
    │              │              │  Parse frame │              │              │
    │              │              │─────────────►│              │              │
    │              │              │  (50ns)      │              │              │
    │              │              │              │              │              │
    │              │              │              │  Acquire     │              │
    │              │              │              │  from pool   │              │
    │              │              │              │  (11ns)      │              │
    │              │              │              │              │              │
    │              │              │              │  Dedup check │              │
    │              │              │              │  (14ns)      │              │
    │              │              │              │              │              │
    │              │              │              │  Route by    │              │
    │              │              │              │  priority    │              │
    │              │              │              │─────────────►│              │
    │              │              │              │  (8-20ns)    │              │
    │              │              │              │              │              │
    │              │              │              │              │  Pop & proc  │
    │              │              │              │              │─────────────►│
    │              │              │              │              │              │
    │              │              │              │              │              │  Process
    │              │              │              │              │              │  (500ns)
    │              │              │              │              │              │
    │              │              │              │              │◄─────────────│
    │◄─────────────┼──────────────┼──────────────┼──────────────┼──────────────│
    │              │              │              │              │     ACK      │
    │              │              │              │              │              │
```

### Timing Breakdown

```
Event Lifecycle Timeline (P99)
═══════════════════════════════════════════════════════════════════════►
│                                                                    Time
│
├─[0ns]─────── Receive ──────────────────────────────────────────────┤
│              │                                                      │
├─[50ns]────── Parse (FrameCodec) ───────────────────────────────────┤
│              │                                                      │
├─[61ns]────── Pool Acquire ─────────────────────────────────────────┤
│              │                                                      │
├─[75ns]────── Dedup Check ──────────────────────────────────────────┤
│              │                                                      │
├─[95ns]────── Queue Push (MPSC) ────────────────────────────────────┤
│              │                                                      │
├─[150ns]───── Queue Pop ────────────────────────────────────────────┤
│              │                                                      │
├─[200ns]───── Dispatch to Worker ───────────────────────────────────┤
│              │                                                      │
├─[500ns]───── Processing ───────────────────────────────────────────┤
│              │                                                      │
├─[1.5µs]───── Complete ─────────────────────────────────────────────┤
│                                                                      │
═══════════════════════════════════════════════════════════════════════►
                               Total P99 < 2µs
```

---

## 🎯 Component Details

### 1. Ingest Layer

```
┌─────────────────────────────────────────────────────────────┐
│                     TCP SERVER                               │
│                                                              │
│   ┌─────────────┐    ┌─────────────────────────────────┐    │
│   │   Acceptor  │───►│         Connection Pool          │    │
│   │   Thread    │    │  ┌─────┐ ┌─────┐ ┌─────┐        │    │
│   └─────────────┘    │  │Conn1│ │Conn2│ │ConnN│        │    │
│                      │  └──┬──┘ └──┬──┘ └──┬──┘        │    │
│                      └─────┼──────┼──────┼─────────────┘    │
│                            │      │      │                   │
│                            ▼      ▼      ▼                   │
│                      ┌─────────────────────────┐             │
│                      │    Frame Reassembly     │             │
│                      │  • TCP stream → frames  │             │
│                      │  • Handle partial reads │             │
│                      └─────────────────────────┘             │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                     UDP SERVER                               │
│                                                              │
│   ┌─────────────────────────────────────────────────────┐   │
│   │                 recvmmsg() batch                     │   │
│   │   ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐          │   │
│   │   │ Pkt 1 │ │ Pkt 2 │ │ Pkt 3 │ │ Pkt N │          │   │
│   │   └───────┘ └───────┘ └───────┘ └───────┘          │   │
│   │              (up to 64 packets per syscall)         │   │
│   └─────────────────────────────────────────────────────┘   │
│                            │                                 │
│                            ▼                                 │
│   ┌─────────────────────────────────────────────────────┐   │
│   │              Zero-Copy Processing                    │   │
│   │  • No buffer copy  • Direct parse  • NUMA-local     │   │
│   └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 2. Queue System

```
┌─────────────────────────────────────────────────────────────────────┐
│                         EVENT BUS MULTI                              │
│                                                                      │
│  Event arrives ──► Check Priority ──► Route to appropriate queue    │
│                          │                                           │
│         ┌────────────────┼────────────────┐                         │
│         │                │                │                         │
│         ▼                ▼                ▼                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                  │
│  │  REALTIME   │  │TRANSACTIONAL│  │    BATCH    │                  │
│  │    Queue    │  │    Queue    │  │    Queue    │                  │
│  ├─────────────┤  ├─────────────┤  ├─────────────┤                  │
│  │ Type: SPSC  │  │ Type: MPSC  │  │ Type: MPSC  │                  │
│  │ Cap: 16K    │  │ Cap: 64K    │  │ Cap: 64K    │                  │
│  │ Lat: ~8ns   │  │ Lat: ~20ns  │  │ Lat: ~20ns  │                  │
│  ├─────────────┤  ├─────────────┤  ├─────────────┤                  │
│  │ Priority:   │  │ Priority:   │  │ Priority:   │                  │
│  │ • CRITICAL  │  │ • MEDIUM    │  │ • LOW       │                  │
│  │ • HIGH      │  │             │  │ • BATCH     │                  │
│  ├─────────────┤  ├─────────────┤  ├─────────────┤                  │
│  │ Use Case:   │  │ Use Case:   │  │ Use Case:   │                  │
│  │ • Alerts    │  │ • Normal    │  │ • Analytics │                  │
│  │ • Safety    │  │   operations│  │ • Logging   │                  │
│  └─────────────┘  └─────────────┘  └─────────────┘                  │
│         │                │                │                         │
│         ▼                ▼                ▼                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                  │
│  │  Worker 0   │  │  Worker 1   │  │  Worker 2   │                  │
│  │ (dedicated) │  │  (shared)   │  │  (shared)   │                  │
│  └─────────────┘  └─────────────┘  └─────────────┘                  │
└─────────────────────────────────────────────────────────────────────┘
```

### 3. Backpressure Flow

```
Normal Operation:
                                                    Queue Depth
┌────────────────────────────────────────────────┐    │
│ RUNNING ──► Events flow normally               │ ◄──┤ 0-60%
└────────────────────────────────────────────────┘    │

Backpressure Activated:
┌────────────────────────────────────────────────┐    │
│ PAUSED ──► Slow down producers (yield)         │ ◄──┤ 60-80%
└────────────────────────────────────────────────┘    │

Draining:
┌────────────────────────────────────────────────┐    │
│ DRAINING ──► Stop accepting new events         │ ◄──┤ 80-90%
└────────────────────────────────────────────────┘    │

Emergency:
┌────────────────────────────────────────────────┐    │
│ DROPPING ──► Drop low-priority events          │ ◄──┤ 90-95%
└────────────────────────────────────────────────┘    │

Critical:
┌────────────────────────────────────────────────┐    │
│ EMERGENCY ──► Only CRITICAL events allowed     │ ◄──┤ 95-100%
└────────────────────────────────────────────────┘    │


State Machine:
                    ┌──────────────────┐
                    │                  │
                    ▼                  │
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│ RUNNING │───►│ PAUSED  │───►│DRAINING │───►│DROPPING │
└─────────┘    └─────────┘    └─────────┘    └─────────┘
     ▲              │              │              │
     │              │              │              ▼
     │              │              │        ┌──────────┐
     └──────────────┴──────────────┴───────►│EMERGENCY │
                    (recovery)              └──────────┘
```

---

## 📊 Data Structures

### Memory Layout

```
┌─────────────────────────────────────────────────────────────────────┐
│                         CACHE LINE OPTIMIZATION                      │
│                                                                      │
│  SpscRingBuffer Memory Layout:                                       │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │ Cache Line 0 (64 bytes)                                        │ │
│  │ ┌──────────────────────────────────────────────────────────┐   │ │
│  │ │  head_ (8 bytes)  │         padding (56 bytes)           │   │ │
│  │ │  [Producer write] │                                      │   │ │
│  │ └──────────────────────────────────────────────────────────┘   │ │
│  ├────────────────────────────────────────────────────────────────┤ │
│  │ Cache Line 1 (64 bytes)                                        │ │
│  │ ┌──────────────────────────────────────────────────────────┐   │ │
│  │ │  tail_ (8 bytes)  │         padding (56 bytes)           │   │ │
│  │ │  [Consumer write] │                                      │   │ │
│  │ └──────────────────────────────────────────────────────────┘   │ │
│  ├────────────────────────────────────────────────────────────────┤ │
│  │ Cache Line 2+ (16K * 8 bytes = 128KB)                          │ │
│  │ ┌──────────────────────────────────────────────────────────┐   │ │
│  │ │  buffer_[0]  buffer_[1]  buffer_[2]  ...  buffer_[16383] │   │ │
│  │ │  [Sequential access - cache friendly]                    │   │ │
│  │ └──────────────────────────────────────────────────────────┘   │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  ❌ False Sharing (BAD):         ✅ Cache Aligned (GOOD):            │
│  ┌────────────────────┐          ┌────────────────────┐             │
│  │ head_ │ tail_      │          │ head_    │ pad     │             │
│  │       │            │          ├──────────┼─────────┤             │
│  │ [Same cache line!] │          │ tail_    │ pad     │             │
│  │ [Both CPUs fight]  │          │ [Separate lines]   │             │
│  └────────────────────┘          └────────────────────┘             │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 🔧 Configuration

```yaml
# config.yaml
server:
  tcp_port: 9000
  udp_port: 9001
  max_connections: 10000

queues:
  realtime:
    type: spsc
    capacity: 16384
  transactional:
    type: mpsc
    capacity: 65536
  batch:
    type: mpsc
    capacity: 65536

numa:
  enabled: true
  node: 0

workers:
  count: 4
  cpu_affinity: [0, 1, 2, 3]

backpressure:
  pause_threshold: 0.6
  drain_threshold: 0.8
  drop_threshold: 0.9
  emergency_threshold: 0.95
```

---

## 📈 Metrics

| Metric | Type | Description |
|--------|------|-------------|
| `events_received_total` | Counter | Total events received |
| `events_processed_total` | Counter | Total events processed |
| `events_dropped_total` | Counter | Events dropped (backpressure) |
| `queue_depth` | Gauge | Current queue size |
| `latency_ns` | Histogram | Processing latency |
| `dedup_hits` | Counter | Duplicate events detected |

---

## ➡️ Next

- [Event Model & Protocol →](event.md)
