@startuml Transactional_Processor
title Transactional Processor (Idempotent Processing)
participant "Input\nQueue" as input
participant "Processor" as processor
participant "Dedup\nInsert" as dedup
participant "Storage\nQueue" as storage
participant "Cleanup\nThread" as cleanup
participant "Metrics" as metrics

loop For Each Event
  input -> processor: pop()
  note right of input: Lock-free SPSC
  
  processor -> dedup: insert(id, timestamp)
  note right of dedup: Lock-free CAS\nNo lock on read!
  
  alt Already Exists
    dedup -> processor: false
    processor -> storage: skip
  else New Event (Insert Success)
    dedup -> processor: true
    processor -> processor: Process idempotent\n(exactly-once)
    note right of processor: 20-40Î¼s
    
    processor -> storage: push(result)
    processor -> metrics: local_new++
  end
end

note over input, metrics: Throughput: 27K eps | Idempotent Window: 1 hour | Cleanup: Every 10min

delay Cleanup (every 10 minutes)

cleanup -> dedup: cleanup()\nRemove old entries
note right of cleanup: Background thread\nNot in hot path

@enduml
