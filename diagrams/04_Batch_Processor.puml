@startuml Batch_Processor
title Batch Processor (Windowed Aggregation)
participant "Input\nQueue" as input
participant "Batch\nProcessor" as processor
participant "Buckets\nMap" as buckets
participant "Storage\nQueue" as storage
participant "Metrics" as metrics

loop For Each Event
  input -> processor: pop()
  note right of input: Lock-free SPSC
  
  processor -> buckets: Get bucket for\n(topic, partition)
  note right of processor: O(1) hash lookup
  
  buckets -> processor: TopicBucket
  note right of buckets: Day 39: Contains\nevent vector +\nlast_flush_time
  
  processor -> buckets: Add to batch\nevents.push_back()
  
  processor -> processor: Check flush condition:\nSize >= 64 events OR\nTime >= 100ms
  
  alt Should Flush
    processor -> processor: Aggregate batch\n(100-500Î¼s)
    buckets -> processor: Clear batch\nReset timer
    processor -> storage: push(aggregated\nresult)
    processor -> metrics: local_batches++
  else Keep Buffering
    processor -> metrics: (no action)
  end
end

note over input, metrics: Throughput: 27K eps | Batch Size: 64 events | Window: 100ms

@enduml
