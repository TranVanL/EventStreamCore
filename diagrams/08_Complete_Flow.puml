@startuml Complete_Flow
title Complete EventStreamCore Flow
participant "Network\n(TCP)" as net
participant "Ingest\nThread" as ingest
participant "EventBus\nThread" as bus
participant "Realtime\nThread" as real
participant "Transactional\nThread" as trans
participant "Batch\nThread" as batch
participant "Storage\nThread" as storage
participant "Metrics\nThread" as metrics

net -> ingest: TCP frame
activate ingest
ingest -> ingest: Parse (2μs)\nPool acquire (0.1μs)
ingest -> bus: push(event)\nLock-free SPSC
deactivate ingest

activate bus
bus -> bus: Route by type\n(O(1) switch)
bus -> real: Push if REALTIME
bus -> trans: Push if TRANSACTIONAL
bus -> batch: Push if BATCH
deactivate bus

par Parallel Processing
  activate real
  real -> real: Pop + Process (30μs)
  real -> storage: Push result
  deactivate real
  
  activate trans
  trans -> trans: Dedup check (lock-free)\nProcess (40μs)
  trans -> storage: Push result
  deactivate trans
  
  activate batch
  batch -> batch: Batch aggregation\n(100-500μs)\nFlush if needed
  batch -> storage: Push aggregated
  deactivate batch
end

activate storage
storage -> storage: Write to backend\n(async)
deactivate storage

activate metrics
metrics -> metrics: Thread-local update\nno lock!
metrics -> metrics: Flush every 1ms\n(1 lock per 1000)
deactivate metrics

note over net, metrics: Single event journey: 50μs-5ms\n82K events/sec sustained throughput

@enduml
